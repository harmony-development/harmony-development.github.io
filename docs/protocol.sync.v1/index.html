<!DOCTYPE html>
<html lang="en-us"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Reference: protocol.sync.v1 | Harmony</title>
    <meta name="description" content="Message Types AuthData Authentication data that will be sent in a harmonytypes.v1.Token.
Fields server_id (optional string) The server ID of the server initiating the transaction. For Pull, this tells the server being connected to which homeservers&#39; events it should send. For Push, this tells the server being connected to which homeservers&#39; events it is receiving.
time (optional uint64) The UTC UNIX time in seconds of when the request is started. Servers should reject tokens with a time too far from the current time, at their discretion. ">
    <link rel="canonical" href="https://harmonyapp.io/docs/protocol.sync.v1/" />

    <link rel="stylesheet" href="/css/codicon.css" />

    

    
      
      <link rel="stylesheet" href="/css/main.min.b599a35d8c7b77592a19cf713bdf6cbf7c404435525e62c590c7c61d88977fb3.css" integrity="sha256-tZmjXYx7d1kqGc9xO99sv3xARDVSXmLFkMfGHYiXf7M="/>
    

    <meta property="og:title" content="Reference: protocol.sync.v1" />
<meta property="og:description" content="Message Types AuthData Authentication data that will be sent in a harmonytypes.v1.Token.
Fields server_id (optional string) The server ID of the server initiating the transaction. For Pull, this tells the server being connected to which homeservers&#39; events it should send. For Push, this tells the server being connected to which homeservers&#39; events it is receiving.
time (optional uint64) The UTC UNIX time in seconds of when the request is started. Servers should reject tokens with a time too far from the current time, at their discretion." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://harmonyapp.io/docs/protocol.sync.v1/" />


    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Reference: protocol.sync.v1"/>
<meta name="twitter:description" content="Message Types AuthData Authentication data that will be sent in a harmonytypes.v1.Token.
Fields server_id (optional string) The server ID of the server initiating the transaction. For Pull, this tells the server being connected to which homeservers&#39; events it should send. For Push, this tells the server being connected to which homeservers&#39; events it is receiving.
time (optional uint64) The UTC UNIX time in seconds of when the request is started. Servers should reject tokens with a time too far from the current time, at their discretion."/>

    <meta name="theme-color" content="#E93D58">
    <meta property="og:image" content="https://harmonyapp.io/img/harmony-embed.png" />

    <script src="https://unpkg.com/quicklink@2.0.0/dist/quicklink.umd.js"></script>
    <script defer>
        quicklink.listen()
    </script>
</head>
<body class="dark:text-white"><header class="w-full bg-gray-200 header flex text-lg">
  <div class="flex flex-row w-full items-center">
    <div class="flex-auto px-3 justify-start order-first inline-flex">
      <a class="font-header" href="/">
        <span class="font-light">Harmony </span
        ><span class="font-bold">Chat</span>
      </a>
    </div>
    <div class="flex-auto p-2 justify-end order-last inline-flex gap-1">
      
      <a
        href="/docs/faq"
        class="
          ml-2
          nu-top-app-bar__link
          h1-minor-minor
          border-2 border-transparent
          px-2
          hover:border-current hover:bg-white hover:bg-opacity-5
          rounded-sm
          transition
          duration-100
        "
      >
        FAQ
      </a>
      
      <a
        href="/docs"
        class="
          ml-2
          nu-top-app-bar__link
          h1-minor-minor
          border-2 border-transparent
          px-2
          hover:border-current hover:bg-white hover:bg-opacity-5
          rounded-sm
          transition
          duration-100
        "
      >
        Docs
      </a>
      
      <a
        href="https://github.com/harmony-development"
        class="
          ml-2
          nu-top-app-bar__link
          h1-minor-minor
          border-2 border-transparent
          px-2
          hover:border-current hover:bg-white hover:bg-opacity-5
          rounded-sm
          transition
          duration-100
        "
      >
        Github
      </a>
      
    </div>
  </div>
</header>
<main>

<div class="prose-wrapper">
  <aside class="prose-toc">
    <h4><strong>Table Of Contents</strong></h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#message-types">Message Types</a>
      <ul>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespanauthdata"><span class="codicon codicon-symbol-structure symbol-structure"></span>AuthData</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespanevent"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuserremovedfromguild"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserRemovedFromGuild</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuseraddedtoguild"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserAddedToGuild</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuserinvited"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserInvited</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuserrejectedinvite"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserRejectedInvite</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespanpullrequest"><span class="codicon codicon-symbol-structure symbol-structure"></span>PullRequest</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespanpullresponse"><span class="codicon codicon-symbol-structure symbol-structure"></span>PullResponse</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespanpushrequest"><span class="codicon codicon-symbol-structure symbol-structure"></span>PushRequest</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespanpushresponse"><span class="codicon codicon-symbol-structure symbol-structure"></span>PushResponse</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespannotifynewidrequest"><span class="codicon codicon-symbol-structure symbol-structure"></span>NotifyNewIdRequest</a></li>
        <li><a href="#span-classcodicon-codicon-symbol-structure-symbol-structurespannotifynewidresponse"><span class="codicon codicon-symbol-structure symbol-structure"></span>NotifyNewIdResponse</a></li>
      </ul>
    </li>
    <li><a href="#services">Services</a>
      <ul>
        <li><a href="#span-classcodicon-codicon-symbol-class-symbol-classspanpostboxservice"><span class="codicon codicon-symbol-class symbol-class"></span>PostboxService</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#server-identification">Server Identification</a></li>
    <li><a href="#authorisation">Authorisation</a></li>
    <li><a href="#events">Events</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>
  <div class="flex justify-center pb-8 w-full">
    <article class="prose">
      <h1 class="h1">Reference: protocol.sync.v1</h1>
      <h2 id="message-types">Message Types</h2>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespanauthdata"><span class="codicon codicon-symbol-structure symbol-structure"></span>AuthData</h3>
<p>Authentication data that will be sent in a <code>harmonytypes.v1.Token</code>.</p>
<h4 id="fields">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanserver_id-optional--string"><span class="codicon codicon-symbol-field symbol-field"></span>server_id (optional  <code>string</code>)</h5>
<p>The server ID of the server initiating the transaction. For Pull,
this tells the server being connected to which homeservers' events it should send.
For Push, this tells the server being connected to which homeservers' events it is
receiving.</p>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspantime-optional--uint64"><span class="codicon codicon-symbol-field symbol-field"></span>time (optional  <code>uint64</code>)</h5>
<p>The UTC UNIX time in seconds of when the request is started. Servers should reject
tokens with a time too far from the current time, at their discretion. A recommended
variance is 1 minute.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespanevent"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event</h3>
<p>Object representing a postbox event.</p>
<h4 id="fields-1">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_removed_from_guild-optional--protocolsyncv1eventuserremovedfromguildeventuserremovedfromguild"><span class="codicon codicon-symbol-field symbol-field"></span>user_removed_from_guild (optional  <a href="#eventuserremovedfromguild">protocol.sync.v1.Event.UserRemovedFromGuild</a>)</h5>
<p>User removed from a guild.</p>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_added_to_guild-optional--protocolsyncv1eventuseraddedtoguildeventuseraddedtoguild"><span class="codicon codicon-symbol-field symbol-field"></span>user_added_to_guild (optional  <a href="#eventuseraddedtoguild">protocol.sync.v1.Event.UserAddedToGuild</a>)</h5>
<p>User added to a guild.</p>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_invited-optional--protocolsyncv1eventuserinvitedeventuserinvited"><span class="codicon codicon-symbol-field symbol-field"></span>user_invited (optional  <a href="#eventuserinvited">protocol.sync.v1.Event.UserInvited</a>)</h5>
<p>User invited to a guild.</p>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_rejected_invite-optional--protocolsyncv1eventuserrejectedinviteeventuserrejectedinvite"><span class="codicon codicon-symbol-field symbol-field"></span>user_rejected_invite (optional  <a href="#eventuserrejectedinvite">protocol.sync.v1.Event.UserRejectedInvite</a>)</h5>
<p>User rejected a guild invitation.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuserremovedfromguild"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserRemovedFromGuild</h3>
<h4 id="fields-2">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_id-optional--uint64"><span class="codicon codicon-symbol-field symbol-field"></span>user_id (optional  <code>uint64</code>)</h5>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanguild_id-optional--uint64"><span class="codicon codicon-symbol-field symbol-field"></span>guild_id (optional  <code>uint64</code>)</h5>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuseraddedtoguild"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserAddedToGuild</h3>
<h4 id="fields-3">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_id-optional--uint64-1"><span class="codicon codicon-symbol-field symbol-field"></span>user_id (optional  <code>uint64</code>)</h5>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanguild_id-optional--uint64-1"><span class="codicon codicon-symbol-field symbol-field"></span>guild_id (optional  <code>uint64</code>)</h5>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuserinvited"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserInvited</h3>
<h4 id="fields-4">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_id-optional--uint64-2"><span class="codicon codicon-symbol-field symbol-field"></span>user_id (optional  <code>uint64</code>)</h5>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspaninviter_id-optional--uint64"><span class="codicon codicon-symbol-field symbol-field"></span>inviter_id (optional  <code>uint64</code>)</h5>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspaninvite_id-optional--string"><span class="codicon codicon-symbol-field symbol-field"></span>invite_id (optional  <code>string</code>)</h5>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespaneventuserrejectedinvite"><span class="codicon codicon-symbol-structure symbol-structure"></span>Event.UserRejectedInvite</h3>
<h4 id="fields-5">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanguild_id-optional--uint64-2"><span class="codicon codicon-symbol-field symbol-field"></span>guild_id (optional  <code>uint64</code>)</h5>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanuser_id-optional--uint64-3"><span class="codicon codicon-symbol-field symbol-field"></span>user_id (optional  <code>uint64</code>)</h5>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspaninvite_id-optional--string-1"><span class="codicon codicon-symbol-field symbol-field"></span>invite_id (optional  <code>string</code>)</h5>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespanpullrequest"><span class="codicon codicon-symbol-structure symbol-structure"></span>PullRequest</h3>
<p>Used in <code>Pull</code> endpoint.</p>
<p>This item has no fields.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespanpullresponse"><span class="codicon codicon-symbol-structure symbol-structure"></span>PullResponse</h3>
<p>Used in <code>Pull</code> endpoint.</p>
<h4 id="fields-6">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanevent_queue-repeated--protocolsyncv1eventevent"><span class="codicon codicon-symbol-field symbol-field"></span>event_queue (repeated  <a href="#event">protocol.sync.v1.Event</a>)</h5>
<p>The events that were not processed yet.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespanpushrequest"><span class="codicon codicon-symbol-structure symbol-structure"></span>PushRequest</h3>
<p>Used in <code>Push</code> endpoint.</p>
<h4 id="fields-7">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspanevent-optional--protocolsyncv1eventevent"><span class="codicon codicon-symbol-field symbol-field"></span>event (optional  <a href="#event">protocol.sync.v1.Event</a>)</h5>
<p>The event to push to the server.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespanpushresponse"><span class="codicon codicon-symbol-structure symbol-structure"></span>PushResponse</h3>
<p>Used in <code>Push</code> endpoint.</p>
<p>This item has no fields.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespannotifynewidrequest"><span class="codicon codicon-symbol-structure symbol-structure"></span>NotifyNewIdRequest</h3>
<p>Used in <code>NotifyNewId</code> endpoint.</p>
<h4 id="fields-8">Fields</h4>
<h5 id="span-classcodicon-codicon-symbol-field-symbol-fieldspannew_server_id-optional--string"><span class="codicon codicon-symbol-field symbol-field"></span>new_server_id (optional  <code>string</code>)</h5>
<p>The new server ID of the server.</p>
<h3 id="span-classcodicon-codicon-symbol-structure-symbol-structurespannotifynewidresponse"><span class="codicon codicon-symbol-structure symbol-structure"></span>NotifyNewIdResponse</h3>
<p>Used in <code>NotifyNewId</code> endpoint.</p>
<p>This item has no fields.</p>
<h2 id="services">Services</h2>
<h3 id="span-classcodicon-codicon-symbol-class-symbol-classspanpostboxservice"><span class="codicon codicon-symbol-class symbol-class"></span>PostboxService</h3>
<h1 id="postbox">Postbox</h1>
<p>The postbox service forms the core of Harmony&rsquo;s server &lt;-&gt; server communications.</p>
<p>It concerns the transfer of Events between servers, as well as ensuring reliable
delivery of them.</p>
<p>The semantics of events are documented in the event types. The postbox service
is solely reliable for reliable pushing and pulling.</p>
<h2 id="server-identification">Server Identification</h2>
<p>Servers are identified using their domain, and the port which they serve. This is
called the &ldquo;server ID&rdquo;, and must be formatted as <code>domain:port</code>. The port is NOT
optional. Converting this ID to a URL for communicating can simply be done via
prefixing the ID with a protocol, eg. <code>https://</code>.</p>
<h2 id="authorisation">Authorisation</h2>
<p>Requests are authorised using a serialized <code>harmonytypes.v1.Token</code> in the Authorization HTTP header.
The <code>data</code> field of the token will be a serialized <code>AuthData</code> message.
The private key used to sign is the homeserver&rsquo;s private key.</p>
<h2 id="events">Events</h2>
<p>In this section, we will use sender and recipient to refer to the servers
sending the events and the server receiving the events respectively.</p>
<p>At PostboxService startup, a sender should first Pull all receivers it had
federated from before. If a receiver makes a Push to the sender while a Pull
is going on, the Push should be processed after the Pull is completed.</p>
<p>The sender will attempt to Push to the receiver. If the Push RPC fails more
than X times (a recommended retry count is 5), the event will be dispatched
to the sender&rsquo;s queue for the receiver. Unless the receiver pulls these events,
all new events should be dispatched to the queue. No new Push RPC should be made
before the queue is emptied. This ensures that events are always received in the
right order.</p>
<p>It is recommended that receivers try pulling periodically, for example, every
1 minute after the last Push RPC by the sender. This ensures that events are recieved.</p>
<h4 id="methods">Methods</h4>
<h5 id="span-classcodicon-codicon-symbol-method-symbol-methodspanpull"><span class="codicon codicon-symbol-method symbol-method"></span>Pull</h5>
<p><a href="#pullrequest">protocol.sync.v1.PullRequest</a> -&gt; <a href="#pullresponse">protocol.sync.v1.PullResponse</a></p>
<p>Endpoint to pull events.</p>
<h5 id="span-classcodicon-codicon-symbol-method-symbol-methodspanpush"><span class="codicon codicon-symbol-method symbol-method"></span>Push</h5>
<p><a href="#pushrequest">protocol.sync.v1.PushRequest</a> -&gt; <a href="#pushresponse">protocol.sync.v1.PushResponse</a></p>
<p>Endpoint to push events.</p>
<h5 id="span-classcodicon-codicon-symbol-method-symbol-methodspannotifynewid"><span class="codicon codicon-symbol-method symbol-method"></span>NotifyNewId</h5>
<p><a href="#notifynewidrequest">protocol.sync.v1.NotifyNewIdRequest</a> -&gt; <a href="#notifynewidresponse">protocol.sync.v1.NotifyNewIdResponse</a></p>
<p>Endpoint to notify a server of a server ID change. It is called by the server
that had it&rsquo;s server ID changed for all servers it has federated with.</p>

    </article>
  </div>
</div>


        </main><footer class="py-8 bg-light-900 dark:bg-dark-900 flex justify-center">
  <div class="max-w-prose">Harmony Development</div>
</footer>
</body>
</html>
